// Conduii Database Schema
// Using Prisma with PostgreSQL (Supabase/Neon compatible)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// USER & ORGANIZATION
// ============================================================================

model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique
  email         String   @unique
  name          String?
  imageUrl      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organizations OrganizationMember[]
  projects      ProjectMember[]
  testRuns      TestRun[]
  apiKeys       ApiKey[]

  @@index([clerkId])
  @@index([email])
}

model Organization {
  id                   String   @id @default(cuid())
  name                 String
  slug                 String   @unique
  imageUrl             String?
  plan                 Plan     @default(FREE)
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  members  OrganizationMember[]
  projects Project[]
  apiKeys  ApiKey[]
  usage    UsageRecord[]

  @@index([slug])
  @@index([stripeCustomerId])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  role           OrgRole      @default(MEMBER)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

// ============================================================================
// PROJECT & CONFIGURATION
// ============================================================================

model Project {
  id             String          @id @default(cuid())
  name           String
  slug           String
  description    String?
  repositoryUrl  String?
  productionUrl  String?
  framework      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  members        ProjectMember[]
  environments   Environment[]
  services       Service[]
  testSuites     TestSuite[]
  testRuns       TestRun[]
  endpoints      Endpoint[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model ProjectMember {
  id        String      @id @default(cuid())
  role      ProjectRole @default(VIEWER)
  createdAt DateTime    @default(now())
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

enum ProjectRole {
  OWNER
  ADMIN
  DEVELOPER
  VIEWER
}

model Environment {
  id           String    @id @default(cuid())
  name         String
  url          String?
  isProduction Boolean   @default(false)
  variables    Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId    String
  testRuns     TestRun[]

  @@unique([projectId, name])
  @@index([projectId])
}

// ============================================================================
// SERVICES & INTEGRATIONS
// ============================================================================

model Service {
  id              String        @id @default(cuid())
  type            ServiceType
  name            String
  status          ServiceStatus @default(UNKNOWN)
  config          Json?
  credentials     Json?
  lastHealthCheck DateTime?
  latency         Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       String
  tests           Test[]
  healthChecks    HealthCheck[]

  @@unique([projectId, type, name])
  @@index([projectId])
  @@index([type])
}

enum ServiceType {
  PLATFORM
  DATABASE
  AUTH
  PAYMENT
  EMAIL
  STORAGE
  ANALYTICS
  MONITORING
  REPOSITORY
  CUSTOM
}

enum ServiceStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

model HealthCheck {
  id        String        @id @default(cuid())
  status    ServiceStatus
  latency   Int?
  error     String?
  details   Json?
  createdAt DateTime      @default(now())
  service   Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId String

  @@index([serviceId])
  @@index([createdAt])
}

// ============================================================================
// ENDPOINTS
// ============================================================================

model Endpoint {
  id          String     @id @default(cuid())
  path        String
  method      HttpMethod @default(GET)
  description String?
  parameters  Json?
  discovered  Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  tests       Test[]

  @@unique([projectId, path, method])
  @@index([projectId])
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  HEAD
  OPTIONS
}

// ============================================================================
// TESTS & TEST RUNS
// ============================================================================

model TestSuite {
  id          String    @id @default(cuid())
  name        String
  description String?
  config      Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  tests       Test[]
  testRuns    TestRun[]

  @@unique([projectId, name])
  @@index([projectId])
}

model Test {
  id          String       @id @default(cuid())
  name        String
  type        TestType
  description String?
  config      Json?
  timeout     Int          @default(30000)
  retries     Int          @default(0)
  enabled     Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  testSuite   TestSuite?   @relation(fields: [testSuiteId], references: [id], onDelete: SetNull)
  testSuiteId String?
  service     Service?     @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  serviceId   String?
  endpoint    Endpoint?    @relation(fields: [endpointId], references: [id], onDelete: SetNull)
  endpointId  String?
  results     TestResult[]

  @@index([testSuiteId])
  @@index([serviceId])
  @@index([type])
}

enum TestType {
  HEALTH
  INTEGRATION
  API
  E2E
  PERFORMANCE
  SECURITY
  CUSTOM
}

model TestRun {
  id            String        @id @default(cuid())
  status        TestRunStatus @default(PENDING)
  trigger       TestTrigger   @default(MANUAL)
  duration      Int?
  startedAt     DateTime?
  finishedAt    DateTime?
  summary       Json?
  metadata      Json?
  createdAt     DateTime      @default(now())
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  environment   Environment?  @relation(fields: [environmentId], references: [id], onDelete: SetNull)
  environmentId String?
  testSuite     TestSuite?    @relation(fields: [testSuiteId], references: [id], onDelete: SetNull)
  testSuiteId   String?
  triggeredBy   User?         @relation(fields: [triggeredById], references: [id], onDelete: SetNull)
  triggeredById String?
  results       TestResult[]
  diagnostics   Diagnostic[]

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
}

enum TestRunStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  CANCELLED
  TIMEOUT
}

enum TestTrigger {
  MANUAL
  SCHEDULED
  WEBHOOK
  GITHUB_ACTION
  CLI
  API
}

model TestResult {
  id         String     @id @default(cuid())
  status     TestStatus
  duration   Int
  error      String?
  assertions Json?
  metadata   Json?
  createdAt  DateTime   @default(now())
  testRun    TestRun    @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  testRunId  String
  test       Test       @relation(fields: [testId], references: [id], onDelete: Cascade)
  testId     String

  @@index([testRunId])
  @@index([testId])
  @@index([status])
}

enum TestStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  SKIPPED
  TIMEOUT
  ERROR
}

model Diagnostic {
  id          String             @id @default(cuid())
  severity    DiagnosticSeverity
  issue       String
  component   String
  description String
  suggestions Json
  createdAt   DateTime           @default(now())
  testRun     TestRun            @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  testRunId   String

  @@index([testRunId])
  @@index([severity])
}

enum DiagnosticSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ============================================================================
// API KEYS & USAGE
// ============================================================================

model ApiKey {
  id             String        @id @default(cuid())
  name           String
  key            String        @unique
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  createdAt      DateTime      @default(now())
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?

  @@index([key])
  @@index([userId])
  @@index([organizationId])
}

model UsageRecord {
  id             String       @id @default(cuid())
  period         DateTime
  testRuns       Int          @default(0)
  apiCalls       Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  @@unique([organizationId, period])
  @@index([organizationId])
  @@index([period])
}
