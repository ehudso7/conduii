generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String               @id @default(cuid())
  clerkId                 String               @unique
  email                   String               @unique
  name                    String?
  imageUrl                String?
  notificationPreferences Json?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  apiKeys                 ApiKey[]
  notifications           Notification[]
  organizations           OrganizationMember[]
  projects                ProjectMember[]
  testRuns                TestRun[]

  @@index([clerkId])
  @@index([email])
}

model Notification {
  id          String           @id @default(cuid())
  type        NotificationType
  title       String
  description String
  read        Boolean          @default(false)
  link        String?
  metadata    Json?
  createdAt   DateTime         @default(now())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model Organization {
  id                     String               @id @default(cuid())
  name                   String
  slug                   String               @unique
  imageUrl               String?
  plan                   Plan                 @default(FREE)
  stripeCustomerId       String?              @unique
  stripeSubscriptionId   String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  projectLimit           Int                  @default(3)
  testRunLimit           Int                  @default(100)
  testRunsUsed           Int                  @default(0)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  apiKeys                ApiKey[]
  members                OrganizationMember[]
  projects               Project[]
  usage                  UsageRecord[]
  webhooks               Webhook[]

  @@index([slug])
  @@index([stripeCustomerId])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  role           OrgRole      @default(MEMBER)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  userId         String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model Project {
  id             String          @id @default(cuid())
  name           String
  slug           String
  description    String?
  repositoryUrl  String?
  productionUrl  String?
  framework      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organizationId String
  endpoints      Endpoint[]
  environments   Environment[]
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        ProjectMember[]
  services       Service[]
  testRuns       TestRun[]
  testSuites     TestSuite[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model ProjectMember {
  id        String      @id @default(cuid())
  role      ProjectRole @default(VIEWER)
  createdAt DateTime    @default(now())
  userId    String
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

model Environment {
  id           String    @id @default(cuid())
  name         String
  url          String?
  isProduction Boolean   @default(false)
  variables    Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  projectId    String
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testRuns     TestRun[]

  @@unique([projectId, name])
  @@index([projectId])
}

model Service {
  id              String        @id @default(cuid())
  type            ServiceType
  name            String
  status          ServiceStatus @default(UNKNOWN)
  config          Json?
  credentials     Json?
  lastHealthCheck DateTime?
  latency         Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  projectId       String
  healthChecks    HealthCheck[]
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tests           Test[]

  @@unique([projectId, type, name])
  @@index([projectId])
  @@index([type])
}

model HealthCheck {
  id        String        @id @default(cuid())
  status    ServiceStatus
  latency   Int?
  error     String?
  details   Json?
  createdAt DateTime      @default(now())
  serviceId String
  service   Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([createdAt])
}

model Endpoint {
  id          String     @id @default(cuid())
  path        String
  method      HttpMethod @default(GET)
  description String?
  parameters  Json?
  discovered  Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tests       Test[]

  @@unique([projectId, path, method])
  @@index([projectId])
}

model TestSuite {
  id          String    @id @default(cuid())
  name        String
  description String?
  config      Json?
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  projectId   String
  tests       Test[]
  testRuns    TestRun[]
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@index([projectId])
}

model Test {
  id          String       @id @default(cuid())
  name        String
  type        TestType
  description String?
  config      Json?
  timeout     Int          @default(30000)
  retries     Int          @default(0)
  enabled     Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  testSuiteId String?
  serviceId   String?
  endpointId  String?
  endpoint    Endpoint?    @relation(fields: [endpointId], references: [id])
  service     Service?     @relation(fields: [serviceId], references: [id])
  testSuite   TestSuite?   @relation(fields: [testSuiteId], references: [id])
  results     TestResult[]

  @@index([testSuiteId])
  @@index([serviceId])
  @@index([type])
}

model TestRun {
  id            String        @id @default(cuid())
  status        TestRunStatus @default(PENDING)
  trigger       TestTrigger   @default(MANUAL)
  duration      Int?
  startedAt     DateTime?
  finishedAt    DateTime?
  summary       Json?
  metadata      Json?
  createdAt     DateTime      @default(now())
  projectId     String
  environmentId String?
  testSuiteId   String?
  triggeredById String?
  diagnostics   Diagnostic[]
  results       TestResult[]
  environment   Environment?  @relation(fields: [environmentId], references: [id])
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testSuite     TestSuite?    @relation(fields: [testSuiteId], references: [id])
  triggeredBy   User?         @relation(fields: [triggeredById], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
}

model TestResult {
  id         String     @id @default(cuid())
  status     TestStatus
  duration   Int
  error      String?
  assertions Json?
  metadata   Json?
  createdAt  DateTime   @default(now())
  testRunId  String
  testId     String
  test       Test       @relation(fields: [testId], references: [id], onDelete: Cascade)
  testRun    TestRun    @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([testRunId])
  @@index([testId])
  @@index([status])
}

model Diagnostic {
  id          String             @id @default(cuid())
  severity    DiagnosticSeverity
  issue       String
  component   String
  description String
  suggestions Json
  createdAt   DateTime           @default(now())
  testRunId   String
  testRun     TestRun            @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([testRunId])
  @@index([severity])
}

model ApiKey {
  id             String        @id @default(cuid())
  name           String
  key            String        @unique
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  revokedAt      DateTime?
  createdAt      DateTime      @default(now())
  userId         String?
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([userId])
  @@index([organizationId])
}

model UsageRecord {
  id             String       @id @default(cuid())
  period         DateTime
  testRuns       Int          @default(0)
  apiCalls       Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, period])
  @@index([organizationId])
  @@index([period])
}

model Webhook {
  id             String          @id @default(cuid())
  name           String
  url            String
  provider       WebhookProvider @default(CUSTOM)
  secret         String?
  events         String[]
  enabled        Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries     WebhookDelivery[]

  @@index([organizationId])
}

model WebhookDelivery {
  id           String                @id @default(cuid())
  eventType     String
  status        WebhookDeliveryStatus
  payload       String
  responseCode  Int
  error         String?
  createdAt     DateTime              @default(now())
  webhookId     String
  webhook       Webhook               @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@index([status])
  id             String            @id @default(cuid())
  name           String
  url            String
  provider       WebhookProvider   @default(CUSTOM)
  secret         String?
  events         String[]
  enabled        Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries     WebhookDelivery[]

  @@index([organizationId])
  @@index([enabled])
}

model WebhookDelivery {
  id           String   @id @default(cuid())
  eventType    String
  status       String
  payload      String
  responseCode Int
  createdAt    DateTime @default(now())
  webhookId    String
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
}

enum NotificationType {
  TEST_PASSED
  TEST_FAILED
  TEST_RUNNING
  SERVICE_DISCOVERED
  USAGE_WARNING
  SYSTEM
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum Plan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum ProjectRole {
  OWNER
  ADMIN
  DEVELOPER
  VIEWER
}

enum ServiceType {
  PLATFORM
  DATABASE
  AUTH
  PAYMENT
  EMAIL
  STORAGE
  ANALYTICS
  MONITORING
  REPOSITORY
  CUSTOM
}

enum ServiceStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  HEAD
  OPTIONS
}

enum TestType {
  HEALTH
  INTEGRATION
  API
  E2E
  PERFORMANCE
  SECURITY
  CUSTOM
}

enum TestRunStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  CANCELLED
  TIMEOUT
}

enum TestTrigger {
  MANUAL
  SCHEDULED
  WEBHOOK
  GITHUB_ACTION
  CLI
  API
}

enum TestStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  SKIPPED
  TIMEOUT
  ERROR
}

enum DiagnosticSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum WebhookProvider {
  SLACK
  DISCORD
  CUSTOM
}

enum WebhookDeliveryStatus {
  DELIVERED
  FAILED
}
