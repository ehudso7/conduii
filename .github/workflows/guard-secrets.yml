name: Guard Secrets

on:
  pull_request:
  push:
    branches: [main]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail if env files are tracked
        shell: bash
        run: |
          set -euo pipefail

          echo "Scanning tracked files for env/secrets patterns..."

          # Only checks tracked files (what would actually get committed).
          # Adjust patterns if you want to be stricter/looser.
          # Note: .env.example and .env.sample files are safe templates - excluded from check.
          matches="$(git ls-files | grep -E '(^|/)\.env($|[^a-zA-Z0-9])|(^|/)\.env\..+|(^|/)\.envrc$|(^|/)\.npmrc$|(^|/)\.pypirc$|(^|/)\.aws/credentials$|(^|/)credentials(\.json)?$|(^|/)id_rsa$|(^|/)id_ed25519$' | grep -v -E '\.env\.(example|sample|template)$' || true)"

          if [[ -n "${matches}" ]]; then
            echo ""
            echo "❌ Blocked: Secret/env-like files are tracked in git:"
            echo "${matches}"
            echo ""
            echo "Fix: remove them from git history for this commit (do NOT delete locally if needed):"
            echo "  git rm --cached <path>"
            echo "  git commit -m \"chore: remove tracked secrets\""
            exit 1
          fi

          echo "✅ OK: No tracked env/secret files found."
