name: Guard Secrets

on:
  pull_request:
  push:
    branches: [main]

jobs:
  guard:
    name: guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fail if real env files are tracked
        shell: bash
        run: |
          set -euo pipefail

          echo "Scanning tracked files for env/secret-like filenames..."

          # Any tracked ".env" or ".env.*" is suspicious…
          tracked_env_files="$(git ls-files | grep -E '(^|/)\.env($|\.)' || true)"

          if [[ -z "${tracked_env_files}" ]]; then
            echo "✅ No tracked .env files found."
            exit 0
          fi

          echo "Found tracked env-like files:"
          echo "${tracked_env_files}"

          # Only checks tracked files (what would actually get committed).
          # Adjust patterns if you want to be stricter/looser.
          # Note: .env.example and .env.sample files are safe templates - excluded from check.
          matches="$(git ls-files | grep -E '(^|/)\.env($|[^a-zA-Z0-9])|(^|/)\.env\..+|(^|/)\.envrc$|(^|/)\.npmrc$|(^|/)\.pypirc$|(^|/)\.aws/credentials$|(^|/)credentials(\.json)?$|(^|/)id_rsa$|(^|/)id_ed25519$' | grep -v -E '\.env\.(example|sample|template)$' || true)"
          # …but these are allowed templates:
          #   .env.example
          #   .env.*.example
          #   .env.sample
          #   .env.template
          blocked="$(echo "${tracked_env_files}" | grep -v -E '(^|/)\.env(\.(example|sample|template)|\..+\.(example|sample|template))$' || true)"

          if [[ -n "${blocked}" ]]; then
            echo ""
            echo "❌ Blocked: Real env files are tracked in git:"
            echo "${blocked}"
            echo ""
            echo "Fix (remove from git index, don't delete locally):"
            echo "  git rm --cached <path>"
            exit 1
          fi

          echo "✅ Only allowed template env files are tracked."

      - name: Scan for obvious secret strings (tracked files only)
        shell: bash
        run: |
          set -euo pipefail

          echo "Scanning tracked files for obvious secret patterns..."

          # NOTE: We intentionally do NOT scan .env.example / template env files here,
          # because they often contain placeholder key names like STRIPE_SECRET_KEY=...
          # and we'd rather enforce "no real values" via review, not fail CI on placeholders.
          #
          # If you want stricter checks later, we can add placeholder enforcement too.

          patterns='(AKIA[0-9A-Z]{16}|-----BEGIN( RSA)? PRIVATE KEY-----|xox[baprs]-[0-9A-Za-z-]{10,}|sk_live_[0-9a-zA-Z]{20,}|rk_live_[0-9a-zA-Z]{20,})'

          if git grep -nE "${patterns}" -- \
            ':!**/.env.example' \
            ':!**/.env.*.example' \
            ':!**/.env.sample' \
            ':!**/.env.*.sample' \
            ':!**/.env.template' \
            ':!**/.env.*.template'
          then
            echo ""
            echo "❌ Potential secret material detected above."
            echo "Replace with placeholders or move to a non-tracked secret manager."
            exit 1
          fi

          echo "✅ No obvious secret material detected."
