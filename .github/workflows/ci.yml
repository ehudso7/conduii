name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests against production'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run linter
        run: yarn lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    env:
      # Dummy values ONLY to satisfy Prisma schema validation during generate/typecheck in CI.
      # Prisma will NOT connect to the DB for generate.
      POSTGRES_PRISMA_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      DIRECT_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      NODE_ENV: "test"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install
        run: yarn install --frozen-lockfile

      - name: Prisma generate (web)
        run: yarn turbo db:generate --filter=web --no-daemon

      - name: Type check (web)
        run: yarn turbo typecheck --filter=web --no-daemon

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    env:
      # Dummy values ONLY to satisfy Prisma schema validation during generate in CI.
      # Dummy values ONLY to satisfy Prisma schema validation during generate/typecheck in CI.
      # Prisma will NOT connect to the DB for generate.
      POSTGRES_PRISMA_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      DIRECT_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      NODE_ENV: "test"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate Prisma Client
        run: yarn db:generate

      - name: Run tests
        run: yarn test

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    env:
      # Dummy values ONLY to satisfy Prisma schema validation during generate in CI.
      # Prisma will NOT connect to the DB for generate.
      POSTGRES_PRISMA_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      DIRECT_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      NODE_ENV: "test"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate Prisma Client
        run: yarn db:generate

      - name: Build packages
        run: |
          yarn build --filter=@conduii/core
          yarn build --filter=@conduii/cli
          yarn build --filter=@conduii/github-action
          yarn build --filter=@conduii/mcp-server

      - name: Build web (with env validation)
        run: yarn build --filter=web
        env:
          # These are required for Next.js build - use secrets or valid placeholders
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          # Skip Prisma validation in CI if DATABASE_URL not set
          PRISMA_SKIP_VALIDATION: ${{ secrets.DATABASE_URL == '' && 'true' || 'false' }}

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    # IMPORTANT: donâ€™t gate on missing secrets unless you want it skipped
    # Run on PRs and pushes, not just manual workflow_dispatch
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}

    env:
      NODE_ENV: test

      # Prisma dummy envs (used for CI bootstrapping)
      # Prisma dummy envs (not connecting to real DB in E2E)
      POSTGRES_PRISMA_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      DIRECT_URL: "postgresql://user:pass@localhost:5432/db?schema=public"

      # Clerk (real keys from GitHub Secrets - use dev/test instance)
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}

    # Run on all PRs and pushes (not just manual dispatch)
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    
    env:
      NODE_ENV: test
      
      # Prisma dummy envs (required for Next.js to boot)
      POSTGRES_PRISMA_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      DIRECT_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      
      # Clerk (REAL keys from GitHub Secrets for E2E testing)
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
    
    # IMPORTANT: don't gate on missing secrets unless you want it skipped
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    env:
      NODE_ENV: test

      # Prisma dummy envs (you already did this pattern elsewhere)
      POSTGRES_PRISMA_URL: "postgresql://user:pass@localhost:5432/db?schema=public"
      DIRECT_URL: "postgresql://user:pass@localhost:5432/db?schema=public"

      # Clerk (REAL keys from GitHub Secrets)
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate Prisma Client
        run: yarn db:generate

      - name: Install Playwright
        run: cd apps/web && npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: cd apps/web && yarn test:e2e

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7

  # Vercel handles preview and production deployments automatically
  # via its GitHub integration. No manual deployment jobs needed.
